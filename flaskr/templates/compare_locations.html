{% extends 'default.html' %}
{% set title = "Choys - main" %}

{% block content %}
    <div class="modal" id="filter-modal">
        <div class="modal-background filter-modal-close"></div>
        <div class="modal-content">
            <div class="box modal-sliders">
                <form action="/" method="get">
                    <div class="notification modal-sort container">
                        <span>
                            Sort By:
                        </span>
                        <div class="select">
                            <select name="sort">
                                {% for category in categories %}
                                    {% if (request.args.get('sort', default='score') == category['id']) %}
                                        <option value="{{ category['id'] }}" selected>{{ category['title'] }}</option>
                                    {% else %}
                                        <option value="{{ category['id'] }}">{{ category['title'] }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="select">
                            <select name="dir">
                                <option value="asc" {{ 'selected' if request.args.get('dir', default='desc') == 'asc' }}>Ascending</option>
                                <option value="desc" {{ 'selected' if request.args.get('dir', default='desc') == 'desc' }}>Descending</option>
                            </select>
                        </div>
                    </div>
                    <table class="table">
                        {% for category in categories[1:] %}
                            <tr>
                                <td>
                                    <label for="{{ category['id'] }}_range">
                                        {{ category['title'] }}
                                    </label>
                                </td>
                                <td>
                                    <input class="slider has-output" type="range" min="{{ category['min'] }}" max="{{ category['max'] }}" id="{{ category['id'] }}_range" name="{{ category['id'] }}" value="{{ request.args.get(category['id'], default=category['max']) }}">
                                </td>
                                <td>
                                    <input class='slider-output' type="number" min="{{ category['min'] }}" max="{{ category['max'] }}" data-for="{{ category['id'] }}_range" value="{{ request.args.get(category['id'], default=category['max']) }}">
                                </td>
                                <td>
                                    <div class="select">
                                        <select class="slider-switch" name="{{ category['id'] }}_switch">
                                            <option value="or-more" {{ 'selected' if request.args.get(category['id'] + '_switch', default='or-less') == 'or-more' }}>or more</option>
                                            <option value="or-less" {{ 'selected' if request.args.get(category['id'] + '_switch', default='or-less') == 'or-less' }}>or less</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                    <div class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <input type="submit" class="button filter-modal-close is-success" value="Close and Filter">
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button type="button" id="filter-modal-reset" class="button is-danger">Clear Filters</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="box modal-loading is-hidden">
                <a class="button is-loading is-large is-fullwidth is-primary">Filtering...</a>
            </div>
        </div>
        <button class="modal-close filter-modal-close is-large" aria-label="close"></button>
    </div>
    <table id='compare_table' class="box table">
        <thead>
            <tr>
                {% for category in categories %}
                    <th>
                        {{ category['title'] }}
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in location_array|sort(attribute=sort, reverse=sort_desc) %}
                {% if row.total_properties > 0 %}
                    <tr>
                        {% set row_data = [
                            {'data_value': row.name, 'content': '<strong>' + row.name + '</strong>'},
                            {'data_value': row.total_properties, 'content': row.total_properties},
                            {'data_value': row.average_rent, 'content': row.average_rent},
                            {'data_value': row.rent_under_250, 'content': row.rent_under_250},
                            {'data_value': row.rent_250_to_500, 'content': row.rent_250_to_500},
                            {'data_value': row.distance_to_london, 'content': row.distance_to_london_text},
                            {'data_value': row.duration_to_london, 'content': row.duration_to_london_text},
                            {'data_value': row.score, 'content': row.score},
                        ] %}
                        {% for cell in row_data %}
                            <td data-value="{{ cell['data_value'] }}" data-category="{{ categories[loop.index0]['id'] }}">
                                {{ cell['content']|safe }}
                            </td>
                        {% endfor %}
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <div id='compare_cards' class="box is-vertical">
        <div id="cards" class="tile is-ancestor is-vertical">
            <div class="tile is-parent">
                {% for row in location_array|sort(attribute=sort, reverse=sort_desc) %}
                    <div class="tile is-child notification is-{{ loop.cycle('link', 'success', 'primary', 'warning', 'danger', 'dark') }} has-text-centered">
                        <div class="title" data-value="{{ row.name }}" data-category="{{ categories[0]['id'] }}">
                            {{ row.name }}
                        </div>

                        <div data-value="{{ row.total_properties }}" data-category="{{ categories[1]['id'] }}">
                            <strong>{{ row.total_properties }}</strong>
                            {% if row.total_properties == 1 %}
                                property
                            {% else %}
                                properties
                            {% endif %}
                        </div>

                        <div data-value="{{ row.average_rent }}" data-category="{{ categories[2]['id'] }}">
                            Average rent is <strong>£{{ row.average_rent }}</strong>
                        </div>

                        <div data-value="{{ row.rent_under_250 }}" data-category="{{ categories[3]['id'] }}">
                            <strong>{{ row.rent_under_250 }}</strong>
                            {% if row.rent_under_250 == 1 %}
                                property
                            {% else %}
                                properties
                            {% endif %}
                            under £250
                        </div>

                        <div data-value="{{ row.rent_250_to_500 }}" data-category="{{ categories[4]['id'] }}">
                            <strong>{{ row.rent_250_to_500 }}</strong>
                            {% if row.rent_250_to_500 == 1 %}
                                property
                            {% else %}
                                properties
                            {% endif %}
                            between £250 and £500
                        </div>

                        <div data-value="{{ row.distance_to_london }}" data-category="{{ categories[5]['id'] }}">
                            <strong>{{ row.distance_to_london_text }}</strong> to London
                        </div>

                        <div data-value="{{ row.duration_to_london }}" data-category="{{ categories[6]['id'] }}">
                            <strong>{{ row.duration_to_london_text }}</strong> to London
                        </div>

                        <div class="notification is-light" data-value="{{ row.score }}" data-category="{{ categories[7]['id'] }}">
                            Score:&nbsp;<strong>{{ row.score|round(3) }}</strong>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

{% block navbar_end_add %}
    <a class="button is-link" id="filter-btn">
        <span>
            Sort &amp; Filter
        </span>
        <span class="icon">
            <i class="fas fa-filter"></i>
        </span>
    </a>
    <a class="button is-danger" id="table-cards-btn">
        <span class="icon">
            <i class="far fa-list-alt"></i>
        </span>
    </a>
{% endblock %}
